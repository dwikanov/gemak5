<!DOCTYPE html>
<html>
<head>
<title>Kontrol Relay Multi-ESP32</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .device-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
  .relay-button {
    padding: 10px 15px;
    margin: 5px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
  }
  .relay-on { background-color: #4CAF50; } /* Green */
  .relay-off { background-color: #f44336; } /* Red */
  .relay-status { margin-left: 10px; font-weight: bold; }
  h2 { margin-top: 0; }
</style>
</head>
<body>

<h1>Sistem Kontrol Relay Jarak Jauh (Multi-ESP32)</h1>

<div id="deviceControls">
  </div>

<h2>Log Aktivitas Terbaru</h2>
<div id="activityLog" style="height: 300px; overflow-y: scroll; border: 1px solid #eee; padding: 10px;">
  Memuat log...
</div>

<script>
  // Ganti dengan Web App URL dari Google Apps Script Anda
  const SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxyp5e0W24AbYP4Revm9_k_SFlh5cWrd8OSBvPWC1kdnXHwNWvWU96MHIw2x15sisho/exec";

  // Daftar Device ID yang Anda gunakan
  const deviceIDs = ["ESP32_1", "ESP32_2"]; // Tambahkan semua Device ID Anda di sini

  // Jumlah relay per ESP32 (sesuaikan jika berbeda)
  const NUM_RELAYS_PER_DEVICE = 5; 

  function createDeviceControl(deviceID) {
    const deviceSection = document.createElement('div');
    deviceSection.className = 'device-section';
    deviceSection.innerHTML = `
      <h2>${deviceID} Controls</h2>
      <div id="relays-${deviceID}">
        </div>
    `;
    document.getElementById('deviceControls').appendChild(deviceSection);

    const relayContainer = deviceSection.querySelector(`#relays-${deviceID}`);
    for (let i = 1; i <= NUM_RELAYS_PER_DEVICE; i++) {
      const relayDiv = document.createElement('div');
      relayDiv.innerHTML = `
        <span>Relay ${i}:</span>
        <button class="relay-button relay-on" onclick="toggleRelay('${deviceID}', ${i}, 'ON')">ON</button>
        <button class="relay-button relay-off" onclick="toggleRelay('${deviceID}', ${i}, 'OFF')">OFF</button>
        <span class="relay-status" id="status-${deviceID}-relay${i}">Unknown</span>
      `;
      relayContainer.appendChild(relayDiv);
    }
  }

  // Buat kontrol untuk setiap perangkat saat halaman dimuat
  deviceIDs.forEach(id => createDeviceControl(id));

  async function toggleRelay(deviceID, relayId, status) {
    console.log(`Toggling ${deviceID} Relay ${relayId} to ${status}`);
    const data = {
      action: "updateRelayStatus",
      device: deviceID,
      relayId: relayId.toString(), // Kirim sebagai string
      status: status,
      initiator: "Web Interface"
    };

    try {
      const response = await fetch(SCRIPT_WEB_APP_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      const result = await response.text();
      console.log(result);
      // Perbarui status tampilan setelah berhasil
      updateRelayStatusDisplay(deviceID, relayId, status);
      fetchActivityLog(); // Muat ulang log aktivitas
    } catch (error) {
      console.error("Error toggling relay:", error);
      alert("Gagal mengubah status relay: " + error.message);
    }
  }

  function updateRelayStatusDisplay(deviceID, relayId, status) {
    const statusSpan = document.getElementById(`status-${deviceID}-relay${relayId}`);
    if (statusSpan) {
      statusSpan.textContent = status;
      statusSpan.style.color = (status === 'ON') ? 'green' : 'red';
    }
  }

  // Fungsi untuk mengambil status awal dari Google Sheet (Opsional, ESP32 yang akan sinkron)
  // Anda bisa membuat fungsi di GAS untuk ini jika ingin web juga menampilkan status aktual saat dimuat
  async function fetchAllRelayStatuses() {
    // Ini akan lebih kompleks karena Anda harus mengambil status per device
    // Untuk kesederhanaan, biarkan ESP32 yang melakukan sinkronisasi
    // Dan log aktivitas yang akan menunjukkan perubahan.
  }

  async function fetchActivityLog() {
    // Anda perlu fungsi doGet di GAS yang bisa mengambil log aktivitas
    // Contoh: SCRIPT_WEB_APP_URL + "?action=getLogs"
    // Untuk saat ini, kita bisa mock data atau mengabaikannya jika GAS belum disiapkan
    try {
      // Asumsikan Anda menambahkan fungsi getLogs di Google Apps Script doGet
      const response = await fetch(SCRIPT_WEB_APP_URL + "?action=getLogs"); 
      const logs = await response.json(); // Asumsikan responsnya adalah array JSON dari log

      const logDiv = document.getElementById('activityLog');
      logDiv.innerHTML = ''; // Bersihkan log sebelumnya
      if (logs && logs.length > 0) {
        logs.forEach(log => {
          const p = document.createElement('p');
          p.textContent = `${log.Timestamp} - ${log.DeviceID} - Relay ${log.RelayID}: ${log.Action} (by ${log.Initiator})`;
          logDiv.appendChild(p);
        });
      } else {
        logDiv.textContent = 'Tidak ada log aktivitas.';
      }
    } catch (error) {
      console.error("Error fetching activity log:", error);
      document.getElementById('activityLog').textContent = 'Gagal memuat log aktivitas.';
    }
  }

  // Panggil saat halaman dimuat
  window.onload = () => {
    fetchActivityLog();
    // Anda juga bisa memanggil fungsi untuk mengambil status relay dari sheet di sini
    // Jika Anda menambahkan endpoint di Google Apps Script untuk itu.
  };

  // Refresh log secara berkala
  setInterval(fetchActivityLog, 5000); // Setiap 5 detik
</script>

</body>
</html>
