<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Kandang</title>

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: '#0B0B0F',
        card: '#111827',
        primary: '#DC2626',
        muted: '#9CA3AF'
      }
    }
  }
}
</script>

<style>
body {
  background:
    radial-gradient(circle at top, rgba(220,38,38,.08), transparent 40%),
    #0B0B0F;
}
.fade { animation: fade .4s ease; }
@keyframes fade {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:none; }
}
.card-hover { transition: all .3s ease; }
.card-hover:hover { transform: translateY(-6px) scale(1.02); }
.glow { box-shadow: 0 0 18px rgba(220,38,38,.6); }
</style>
</head>

<body class="text-white min-h-screen">

<!-- ================= LOGIN ================= -->
<section id="loginPage" class="min-h-screen flex items-center justify-center fade">

  <div class="w-full max-w-md bg-card p-8 rounded-3xl shadow-2xl border border-white/10">
    <h1 class="text-3xl font-bold mb-6 text-center">Smart Kandang</h1>

    <form id="loginForm" class="space-y-4">
      <input id="email" type="email" placeholder="Email"
        class="w-full p-3 rounded-xl bg-bg border border-white/10 focus:ring-2 focus:ring-primary outline-none">

      <input id="password" type="password" placeholder="Password"
        class="w-full p-3 rounded-xl bg-bg border border-white/10 focus:ring-2 focus:ring-primary outline-none">

      <label class="flex items-center gap-2 text-sm text-muted">
        <input type="checkbox" id="remember" class="accent-primary">
        Tetap Login
      </label>

      <button
        class="w-full bg-primary hover:bg-red-700 glow p-3 rounded-xl font-semibold transition">
        Masuk
      </button>
    </form>

    <p id="loginError" class="text-red-400 text-sm mt-4 hidden"></p>
  </div>

</section>

<!-- ================= DASHBOARD ================= -->
<section id="dashboardPage" class="hidden fade">

  <main class="
  min-h-screen
  flex
  items-center
  justify-center
  p-4
">


    <!-- APP CONTAINER -->
<div class="
  w-full max-w-5xl
  bg-card/80 backdrop-blur
  rounded-3xl
  shadow-2xl
  border border-white/10
  p-6 md:p-8
  max-h-[90vh]
  overflow-y-auto
">


      <!-- HEADER -->
      <div class="mb-8">
        <h2 class="text-2xl md:text-3xl font-bold">Dashboard</h2>
        <p class="text-sm text-muted">Smart Kandang Control Panel</p>
      </div>

      <!-- ================= OVERVIEW ================= -->
      <section id="overviewView">
        <div id="overviewGrid"
          class="grid grid-cols-2 gap-4 md:gap-6">
        </div>
      </section>

      <!-- ================= DETAIL ================= -->
      <section id="detailView" class="hidden fade">

        <div class="
          bg-bg/60
          border border-white/10
          rounded-2xl
          p-6
        ">

          <div class="flex items-center justify-between mb-6">
            <button id="backBtn"
              class="text-muted hover:text-white transition">
              ‚Üê Kembali
            </button>

            <h3 id="detailTitle"
              class="text-xl md:text-2xl font-bold">
              Kandang
            </h3>

            <span id="detailStatus"
              class="w-3 h-3 rounded-full">
            </span>
          </div>

          <!-- LAMPU -->
          <div id="lampGrid"
            class="grid grid-cols-2 gap-4 mb-6">
          </div>

          <!-- KIPAS -->
          <button id="kipasBtn"
            class="w-full p-4 rounded-xl font-semibold transition">
            üåÄ Kipas
          </button>

        </div>
      </section>

    </div>
  </main>
</section>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  setPersistence,
  browserLocalPersistence,
  browserSessionPersistence,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  onValue,
  update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* === CONFIG === */
const firebaseConfig = {
  apiKey: "AIzaSyDprQw_5Gd-LksX4hCWaZkBhdiSPw8qqm0",
  authDomain: "switch-lamp-3c346.firebaseapp.com",
  databaseURL: "https://switch-lamp-3c346-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "switch-lamp-3c346",
  storageBucket: "switch-lamp-3c346.firebasestorage.app",
  messagingSenderId: "375935971674",
  appId: "1:375935971674:web:1f95dcf367151a9d7cc363"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= STATE ================= */
let deviceCache = {};
let selectedDevice = null;

/* ================= AUTH ================= */
onAuthStateChanged(auth, user => {
  user ? showDashboard() : showLogin();
});

loginForm.onsubmit = async e => {
  e.preventDefault();
  loginError.classList.add('hidden');

  try {
    await setPersistence(
      auth,
      remember.checked
        ? browserLocalPersistence
        : browserSessionPersistence
    );

    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
  } catch (err) {
    loginError.textContent = err.message;
    loginError.classList.remove('hidden');
  }
};

function showDashboard() {
  loginPage.classList.add('hidden');
  dashboardPage.classList.remove('hidden');
}

function showLogin() {
  dashboardPage.classList.add('hidden');
  loginPage.classList.remove('hidden');
}

/* ================= REALTIME ================= */
onValue(ref(db, 'devices'), snap => {
  deviceCache = snap.val() || {};
  renderOverview();
  if (selectedDevice) renderDetail();
});

/* ================= HELPERS ================= */
function formatKandang(id) {
  return id.replace('kandang', 'Kandang ');
}

/* ================= OVERVIEW ================= */
function renderOverview() {
  overviewGrid.innerHTML = '';

  Object.entries(deviceCache).forEach(([id, d]) => {
    const online =
      d.status?.online &&
      (Date.now() - d.status.last_seen < 10000);

    overviewGrid.innerHTML += `
      <div onclick="openDetail('${id}')"
        class="bg-bg/60 border border-white/10
        p-6 rounded-2xl card-hover cursor-pointer relative">

        <span class="absolute top-4 right-4 w-3 h-3 rounded-full
          ${online ? 'bg-green-400 animate-pulse' : 'bg-red-500'}"></span>

        <h3 class="text-lg font-semibold">${formatKandang(id)}</h3>
      </div>
    `;
  });
}

/* ================= DETAIL ================= */
window.openDetail = id => {
  selectedDevice = id;
  overviewView.classList.add('hidden');
  detailView.classList.remove('hidden');
  renderDetail();
};

function renderDetail() {
  const d = deviceCache[selectedDevice];
  if (!d) return;

  detailTitle.textContent = formatKandang(selectedDevice);

  const online =
    d.status?.online &&
    (Date.now() - d.status.last_seen < 10000);

  detailStatus.className =
    `w-3 h-3 rounded-full ${online ? 'bg-green-400 animate-pulse' : 'bg-red-500'}`;

  lampGrid.innerHTML = `
    ${lampBtn('Lampu 1','lampu1',d.lampu1)}
    ${lampBtn('Lampu 2','lampu2',d.lampu2)}
    ${lampBtn('Lampu 3','lampu3',d.lampu3)}
  `;

  kipasBtn.className =
    `w-full p-4 rounded-xl font-semibold transition
     ${d.kipas ? 'bg-primary glow' : 'bg-primary/20'}`;

  kipasBtn.onclick = () =>
    toggle(selectedDevice,'kipas',d.kipas);
}

/* ================= COMPONENT ================= */
function lampBtn(label, field, state) {
  return `
    <button onclick="toggle('${selectedDevice}','${field}',${state})"
      class="${state ? 'bg-primary glow' : 'bg-primary/20'}
      p-4 rounded-xl font-semibold transition active:scale-95">
      üí° ${label}
    </button>
  `;
}

/* ================= TOGGLE ================= */
window.toggle = (device, field, current) => {
  update(ref(db, `devices/${device}`), {
    [field]: !current
  });
};

/* ================= BACK ================= */
backBtn.onclick = () => {
  detailView.classList.add('hidden');
  overviewView.classList.remove('hidden');
  selectedDevice = null;
};
</script>

</body>
</html>
