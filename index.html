<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Smart Kandang</title>

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: '#0B0B0F',
        card: '#111827',
        primary: '#DC2626',
        muted: '#9CA3AF'
      }
    }
  }
}
</script>

<style>
.glow-red { box-shadow: 0 0 20px rgba(220,38,38,.6); }
.fade { animation: fade .4s ease; }
@keyframes fade {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:none; }
}
.card-hover {
  transition: all .3s ease;
}
.card-hover:hover {
  transform: translateY(-6px) scale(1.02);
}
</style>
</head>

<body class="bg-bg text-white min-h-screen">

<!-- ================= LOGIN ================= -->
<section id="loginPage" class="min-h-screen flex items-center justify-center fade">

  <div class="w-full max-w-md bg-card p-8 rounded-3xl shadow-2xl">
    <h1 class="text-3xl font-bold mb-6 text-center">Smart Kandang</h1>

    <form id="loginForm" class="space-y-4">
      <input id="email" type="email" placeholder="Email"
        class="w-full p-3 rounded-xl bg-bg border border-white/10 focus:ring-2 focus:ring-primary outline-none">

      <input id="password" type="password" placeholder="Password"
        class="w-full p-3 rounded-xl bg-bg border border-white/10 focus:ring-2 focus:ring-primary outline-none">

      <label class="flex items-center gap-2 text-sm text-muted">
        <input type="checkbox" id="remember" class="accent-primary">
        Tetap login
      </label>

      <button
        class="w-full bg-primary hover:bg-red-700 glow-red p-3 rounded-xl font-semibold transition active:scale-95">
        Masuk
      </button>
    </form>

    <p id="loginError" class="text-red-400 text-sm mt-4 hidden"></p>
  </div>

</section>

<!-- ================= DASHBOARD ================= -->
<section id="dashboardPage" class="hidden fade">

  <!-- SIDEBAR -->
  <aside class="
    fixed md:static bottom-0 w-full md:w-20
    h-16 md:h-auto bg-card
    flex md:flex-col justify-around md:justify-start
    items-center py-4 gap-6 z-50">

    <span class="text-xl">ğŸ </span>
    <span class="text-xl">ğŸ£</span>
    <span class="text-xl">âš™ï¸</span>
    <button id="logout" class="text-red-400 text-xl">â‹</button>
  </aside>

  <!-- MAIN -->
  <main class="md:ml-20 p-6 pb-24 md:pb-6">
    <h2 class="text-3xl font-bold mb-6">Dashboard</h2>

    <div id="deviceGrid"
      class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
      <!-- card kandang render di JS -->
    </div>
  </main>

</section>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  setPersistence,
  browserLocalPersistence,
  browserSessionPersistence,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getDatabase,
  ref,
  onValue,
  update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* === CONFIG KAMU === */
const firebaseConfig = {
  apiKey: "AIzaSyDprQw_5Gd-LksX4hCWaZkBhdiSPw8qqm0",
  authDomain: "switch-lamp-3c346.firebaseapp.com",
  databaseURL: "https://switch-lamp-3c346-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "switch-lamp-3c346",
  storageBucket: "switch-lamp-3c346.firebasestorage.app",
  messagingSenderId: "375935971674",
  appId: "1:375935971674:web:1f95dcf367151a9d7cc363"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= PAGE CONTROL ================= */
const loginPage = document.getElementById('loginPage');
const dashboardPage = document.getElementById('dashboardPage');

function showDashboard() {
  loginPage.classList.add('hidden');
  dashboardPage.classList.remove('hidden');
}

function showLogin() {
  dashboardPage.classList.add('hidden');
  loginPage.classList.remove('hidden');
}

onAuthStateChanged(auth, user => {
  user ? showDashboard() : showLogin();
});

/* ================= LOGIN ================= */
loginForm.onsubmit = async e => {
  e.preventDefault();
  loginError.classList.add('hidden');

  try {
    await setPersistence(
      auth,
      remember.checked
        ? browserLocalPersistence
        : browserSessionPersistence
    );

    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
  } catch (err) {
    loginError.textContent = err.message;
    loginError.classList.remove('hidden');
  }
};

logout.onclick = () => signOut(auth);

/* ================= REALTIME DB ================= */
const devicesRef = ref(db, 'devices');

onValue(devicesRef, snap => {
  const devices = snap.val();
  renderDevices(devices);
});

/* ================= RENDER ================= */
function renderDevices(devices) {
  deviceGrid.innerHTML = '';

  Object.entries(devices).forEach(([id, d]) => {

    const online =
      d.status?.online &&
      (Date.now() - d.status.last_seen < 10000);

    deviceGrid.innerHTML += `
      <div class="bg-card p-6 rounded-2xl card-hover relative">

        <span class="absolute top-4 right-4 w-3 h-3 rounded-full
          ${online ? 'bg-green-400 animate-pulse' : 'bg-red-500'}">
        </span>

        <h3 class="font-semibold mb-3 capitalize">${id}</h3>

        <div class="grid grid-cols-3 gap-2 mb-3">
          ${lampBtn(id,'lampu1',d.lampu1)}
          ${lampBtn(id,'lampu2',d.lampu2)}
          ${lampBtn(id,'lampu3',d.lampu3)}
        </div>

        <button onclick="toggle('${id}','kipas',${d.kipas})"
          class="w-full ${d.kipas ? 'bg-primary' : 'bg-primary/20'}
          p-2 rounded-lg transition active:scale-95">
          ğŸŒ€ Kipas
        </button>
      </div>
    `;
  });
}

/* ================= COMPONENT ================= */
function lampBtn(id, lamp, state) {
  return `
    <button onclick="toggle('${id}','${lamp}',${state})"
      class="${state ? 'bg-primary' : 'bg-primary/20'}
      p-2 rounded-lg text-sm transition active:scale-95">
      ğŸ’¡ ${lamp}
    </button>
  `;
}

/* ================= TOGGLE ================= */
window.toggle = (device, field, current) => {
  update(ref(db, `devices/${device}`), {
    [field]: !current
  });
};
</script>

</body>
</html>
