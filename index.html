<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Kandang</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg:'#0B0B0F', card:'#111827', primary:'#DC2626', muted:'#9CA3AF'
      }
    }
  }
}
</script>
</head>

<body class="bg-bg text-white min-h-screen">

<!-- ================= LOGIN ================= -->
<section id="loginPage" class="min-h-screen flex items-center justify-center">
  <div class="bg-card p-8 rounded-3xl w-full max-w-md">
    <h1 class="text-3xl font-bold mb-6 text-center">Smart Kandang</h1>
    <form id="loginForm" class="space-y-4">
      <input id="email" class="w-full p-3 rounded bg-bg" placeholder="Email">
      <input id="password" type="password" class="w-full p-3 rounded bg-bg" placeholder="Password">
      <button class="w-full bg-primary p-3 rounded font-semibold">Masuk</button>
    </form>
  </div>
</section>

<!-- ================= DASHBOARD ================= -->
<section id="dashboardPage" class="hidden">
<main class="p-4 md:p-8 flex justify-center">
<div class="w-full max-w-5xl bg-card/80 border border-white/10 rounded-3xl p-6">

<!-- HEADER -->
<h2 class="text-2xl font-bold mb-6 cursor-pointer" onclick="show('overview')">
Dashboard
</h2>

<!-- ===== OVERVIEW ===== -->
<section id="overviewView">
  <div id="overviewGrid" class="grid grid-cols-2 gap-4"></div>
</section>

<!-- ===== DETAIL ===== -->
<section id="detailView" class="hidden">
  <div class="flex items-center justify-between mb-4">
    <button onclick="show('overview')">‚Üê</button>
    <h3 id="detailTitle" class="font-bold"></h3>
    <button onclick="show('wifiStatus')" id="wifiName">WiFi</button>
  </div>

  <div id="lampGrid" class="grid grid-cols-2 gap-3 mb-4"></div>

  <button id="kipasBtn" class="w-full p-3 rounded bg-primary/20">
    üåÄ Kipas
  </button>
</section>

<!-- ===== WIFI STATUS ===== -->
<section id="wifiStatusView" class="hidden">
  <button onclick="show('detail')">‚Üê</button>
  <p class="mt-4">Nama WiFi:</p>
  <p id="currentSSID" class="font-bold mb-4">-</p>
  <button onclick="startScan()" class="bg-primary p-3 rounded w-full">
    Ganti WiFi
  </button>
</section>

<!-- ===== WIFI SCAN ===== -->
<section id="wifiScanView" class="hidden">
  <button onclick="show('wifiStatus')">‚Üê</button>
  <div id="wifiList" class="mt-4 space-y-2"></div>
</section>

<!-- ===== WIFI PASSWORD ===== -->
<section id="wifiPasswordView" class="hidden">
  <button onclick="show('wifiScan')">‚Üê</button>
  <h3 id="ssidTitle" class="font-bold mb-3"></h3>
  <input id="wifiPassword" class="w-full p-3 rounded bg-bg" placeholder="Password">
  <button onclick="connectWifi()" class="w-full bg-primary p-3 rounded mt-4">
    Sambungkan
  </button>
</section>

<!-- ===== WIFI LOADING ===== -->
<section id="wifiLoadingView" class="hidden text-center">
  <p id="wifiLoadingText" class="text-xl">‚è≥ Harap tunggu</p>
</section>

</div>
</main>
</section>

<!-- ================= JS ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, onValue, update }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDprQw_5Gd-LksX4hCWaZkBhdiSPw8qqm0",
  authDomain:"switch-lamp-3c346.firebaseapp.com",
  databaseURL:"https://switch-lamp-3c346-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth = getAuth(app);
const db = getDatabase(app);

let currentView = 'overview';
let selectedDevice = null;
let selectedSSID = '';
let cache = {};

window.show = view => {
  currentView = view;
  overviewView.classList.toggle('hidden', view!=='overview');
  detailView.classList.toggle('hidden', view!=='detail');
  wifiStatusView.classList.toggle('hidden', view!=='wifiStatus');
  wifiScanView.classList.toggle('hidden', view!=='wifiScan');
  wifiPasswordView.classList.toggle('hidden', view!=='wifiPassword');
  wifiLoadingView.classList.toggle('hidden', view!=='wifiLoading');
};

onAuthStateChanged(auth,u=>{
  loginPage.classList.toggle('hidden',!!u);
  dashboardPage.classList.toggle('hidden',!u);
});

loginForm.onsubmit=e=>{
  e.preventDefault();
  signInWithEmailAndPassword(auth,email.value,password.value);
};

onValue(ref(db,'devices'),s=>{
  cache=s.val()||{};
  renderOverview();
  if(selectedDevice) renderDetail();
});

function renderOverview(){
  overviewGrid.innerHTML='';
  Object.keys(cache).forEach(id=>{
    overviewGrid.innerHTML+=`
      <div onclick="openDetail('${id}')"
      class="p-4 bg-bg/60 rounded cursor-pointer">${id}</div>`;
  });
}

window.openDetail=id=>{
  selectedDevice=id;
  renderDetail();
  show('detail');
};

function renderDetail(){
  const d=cache[selectedDevice];
  detailTitle.textContent=selectedDevice;
  wifiName.textContent=d.wifi?.current?.ssid||'Offline';

  lampGrid.innerHTML=['lampu1','lampu2','lampu3']
    .map(l=>`<button onclick="toggle('${l}',${d[l]})"
    class="p-3 rounded ${d[l]?'bg-primary':'bg-primary/20'}">${l}</button>`).join('');

  kipasBtn.onclick=()=>toggle('kipas',d.kipas);
}

window.toggle=(f,v)=>update(ref(db,`devices/${selectedDevice}`),{[f]:!v});

window.startScan=()=>{
  update(ref(db,`devices/${selectedDevice}/wifi/request`),{cmd:'scan'});
  show('wifiScan');
};

window.selectWifi=ssid=>{
  selectedSSID=ssid;
  ssidTitle.textContent=ssid;
  show('wifiPassword');
};

window.connectWifi=()=>{
  update(ref(db,`devices/${selectedDevice}/wifi/request`),
  {cmd:'connect',ssid:selectedSSID,password:wifiPassword.value});
  show('wifiLoading');
};
</script>

</body>
</html>
